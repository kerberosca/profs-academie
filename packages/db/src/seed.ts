import { db } from "./db";
import { hashPassword, hashPin } from "./auth";
import { Prisma } from "@prisma/client";

async function main() {
  console.log("üå± D√©but du seeding...");

  // Nettoyer la base de donn√©es
  await db.auditLog.deleteMany();
  await db.consentement.deleteMany();
  await db.soumission.deleteMany();
  await db.progression.deleteMany();
  await db.question.deleteMany();
  await db.quiz.deleteMany();
  await db.lecon.deleteMany();
  await db.module.deleteMany();
  await db.cours.deleteMany();
  await db.enfant.deleteMany();
  await db.foyer.deleteMany();
  await db.profilProf.deleteMany();
  await db.abonnement.deleteMany();
  await db.plan.deleteMany();
  await db.user.deleteMany();

  // Cr√©er les plans d'abonnement
  const plans = await Promise.all([
    db.plan.create({
      data: {
        key: "essentiel",
        nom: "Essentiel",
        prixCents: 1999, // 19.99$
        intervalle: "MONTH",
        nbEnfants: 1,
        description: "Parfait pour commencer l'apprentissage",
        features: ["1 enfant", "Acc√®s √† tous les cours", "Suivi de progression", "Support par email"],
      },
    }),
    db.plan.create({
      data: {
        key: "famille",
        nom: "Famille",
        prixCents: 3999, // 39.99$
        intervalle: "MONTH",
        nbEnfants: 5,
        description: "Id√©al pour les familles nombreuses",
        features: ["Jusqu'√† 5 enfants", "Acc√®s √† tous les cours", "Suivi de progression", "Support prioritaire"],
      },
    }),
    db.plan.create({
      data: {
        key: "prof",
        nom: "Prof Cr√©ateur",
        prixCents: 999, // 9.99$
        intervalle: "MONTH",
        nbEnfants: 10,
        description: "Pour les enseignants qui veulent cr√©er du contenu",
        features: ["Jusqu'√† 10 enfants", "Studio de cr√©ation", "Publier des cours", "Analytics avanc√©es"],
      },
    }),
  ]);

  console.log("‚úÖ Plans cr√©√©s");

  // Cr√©er l'admin
  const adminPassword = await hashPassword("admin123");
  const admin = await db.user.create({
    data: {
      email: "admin@profsacademie.ca",
      motDePasseHash: adminPassword,
      nom: "Administrateur",
      role: "ADMIN",
      verifiedAt: new Date(),
    },
  });

  console.log("‚úÖ Admin cr√©√©");

  // Cr√©er un enseignant
  const profPassword = await hashPassword("prof123");
  const prof = await db.user.create({
    data: {
      email: "prof@profsacademie.ca",
      motDePasseHash: profPassword,
      nom: "Marie Dubois",
      role: "TEACHER",
      verifiedAt: new Date(),
      profilProf: {
        create: {
          statut: "APPROVED",
          bio: "Enseignante passionn√©e de math√©matiques avec 10 ans d'exp√©rience",
        },
      },
    },
  });

  console.log("‚úÖ Enseignant cr√©√©");

  // Cr√©er un parent avec foyer et enfants
  const parentPassword = await hashPassword("parent123");
  const parent = await db.user.create({
    data: {
      email: "parent@profsacademie.ca",
      motDePasseHash: parentPassword,
      nom: "Jean Tremblay",
      role: "PARENT",
      verifiedAt: new Date(),
      foyer: {
        create: {
          nom: "Famille Tremblay",
        },
      },
    },
  });

  const foyer = await db.foyer.findUnique({
    where: { parentId: parent.id },
  });

  if (!foyer) throw new Error("Foyer non trouv√©");

  // Cr√©er les enfants
  const enfant1Pin = await hashPin("1234");
  const enfant2Pin = await hashPin("5678");

  const [enfant1, enfant2] = await Promise.all([
    db.enfant.create({
      data: {
        prenom: "Emma",
        anneeNaissance: 2015,
        pinHash: enfant1Pin,
        foyerId: foyer.id,
      },
    }),
    db.enfant.create({
      data: {
        prenom: "Lucas",
        anneeNaissance: 2018,
        pinHash: enfant2Pin,
        foyerId: foyer.id,
      },
    }),
  ]);

  console.log("‚úÖ Parent et enfants cr√©√©s");

  // Cr√©er un abonnement pour le parent
  await db.abonnement.create({
    data: {
      userId: parent.id,
      planId: plans[1].id, // Plan Famille
      statut: "ACTIVE",
      finPeriode: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // +30 jours
    },
  });

  console.log("‚úÖ Abonnement cr√©√©");

  // Cr√©er un cours de d√©monstration
  const cours = await db.cours.create({
    data: {
      titre: "Introduction aux Math√©matiques - Niveau Primaire",
      slug: "math-primaire-intro",
      matiere: "Math√©matiques",
      niveau: "Primaire",
      resume: "Un cours complet pour ma√Ætriser les bases des math√©matiques au primaire",
      statut: "PUBLISHED",
      auteurId: prof.id,
    },
  });

  // Cr√©er les modules
  const [module1, module2] = await Promise.all([
    db.module.create({
      data: {
        titre: "Les Nombres",
        ordre: 1,
        coursId: cours.id,
      },
    }),
    db.module.create({
      data: {
        titre: "Les Op√©rations",
        ordre: 2,
        coursId: cours.id,
      },
    }),
  ]);

  // Cr√©er les le√ßons
  const lecons = await Promise.all([
    db.lecon.create({
      data: {
        titre: "Compter jusqu'√† 100",
        slug: "compter-100",
        mdx: `# Compter jusqu'√† 100

Bienvenue dans cette le√ßon sur les nombres !

## Objectifs d'apprentissage
- Reconna√Ætre les nombres de 1 √† 100
- Compter par dizaines
- √âcrire les nombres en chiffres

## Activit√© interactive
Comptons ensemble : 1, 2, 3, 4, 5...

### Exercice
Compl√©tez la suite : 10, 20, 30, ___, 50

**R√©ponse : 40**

## R√©sum√©
Vous savez maintenant compter jusqu'√† 100 !`,
        dureeMin: 15,
        ordre: 1,
        moduleId: module1.id,
      },
    }),
    db.lecon.create({
      data: {
        titre: "L'addition simple",
        slug: "addition-simple",
        mdx: `# L'addition simple

## Qu'est-ce que l'addition ?
L'addition, c'est quand on ajoute des nombres ensemble.

### Exemple
2 + 3 = 5

## R√®gles importantes
- On peut additionner dans n'importe quel ordre
- 2 + 3 = 3 + 2 = 5

## Exercices pratiques
1. 4 + 5 = ?
2. 7 + 2 = ?
3. 1 + 9 = ?

**R√©ponses : 9, 9, 10**`,
        dureeMin: 20,
        ordre: 2,
        moduleId: module1.id,
      },
    }),
    db.lecon.create({
      data: {
        titre: "La soustraction",
        slug: "soustraction",
        mdx: `# La soustraction

## D√©finition
La soustraction, c'est l'op√©ration inverse de l'addition.

### Exemple
5 - 2 = 3

## Astuce
Pensez √† l'addition : 3 + 2 = 5, donc 5 - 2 = 3

## Exercices
1. 8 - 3 = ?
2. 10 - 4 = ?
3. 7 - 1 = ?

**R√©ponses : 5, 6, 6**`,
        dureeMin: 18,
        ordre: 1,
        moduleId: module2.id,
      },
    }),
    db.lecon.create({
      data: {
        titre: "Les tables de multiplication",
        slug: "multiplication",
        mdx: `# Les tables de multiplication

## Table de 2
2 √ó 1 = 2
2 √ó 2 = 4
2 √ó 3 = 6
2 √ó 4 = 8
2 √ó 5 = 10

## Table de 5
5 √ó 1 = 5
5 √ó 2 = 10
5 √ó 3 = 15
5 √ó 4 = 20
5 √ó 5 = 25

## Exercice
Compl√©tez : 2 √ó 6 = ___

**R√©ponse : 12**`,
        dureeMin: 25,
        ordre: 2,
        moduleId: module2.id,
      },
    }),
  ]);

  console.log("‚úÖ Cours et le√ßons cr√©√©s");

  // Cr√©er des quiz
  const quiz1 = await db.quiz.create({
    data: {
      titre: "Quiz sur les nombres",
      ordre: 1,
      leconId: lecons[0].id,
    },
  });

  const quiz2 = await db.quiz.create({
    data: {
      titre: "Quiz sur l'addition",
      ordre: 1,
      leconId: lecons[1].id,
    },
  });

  // Cr√©er les questions
  await Promise.all([
    // Questions pour le quiz 1
    db.question.create({
      data: {
        type: "SINGLE",
        enonce: "Quel nombre vient apr√®s 25 ?",
        options: ["24", "25", "26", "27"],
        cleReponse: "26",
        ordre: 1,
        quizId: quiz1.id,
      },
    }),
    db.question.create({
      data: {
        type: "MULTIPLE",
        enonce: "Quels sont les nombres pairs ?",
        options: ["2", "3", "4", "5", "6"],
        cleReponse: ["2", "4", "6"],
        ordre: 2,
        quizId: quiz1.id,
      },
    }),
    db.question.create({
      data: {
        type: "SHORT",
        enonce: "√âcrivez le nombre qui vient apr√®s 99",
        cleReponse: "100",
        ordre: 3,
        quizId: quiz1.id,
      },
    }),
    // Questions pour le quiz 2
    db.question.create({
      data: {
        type: "SINGLE",
        enonce: "Combien font 7 + 3 ?",
        options: ["8", "9", "10", "11"],
        cleReponse: "10",
        ordre: 1,
        quizId: quiz2.id,
      },
    }),
    db.question.create({
      data: {
        type: "SINGLE",
        enonce: "Quel est le r√©sultat de 5 + 5 ?",
        options: ["9", "10", "11", "12"],
        cleReponse: "10",
        ordre: 2,
        quizId: quiz2.id,
      },
    }),
  ]);

  console.log("‚úÖ Quiz et questions cr√©√©s");

  // Cr√©er quelques progressions pour Emma
  await Promise.all([
    db.progression.create({
      data: {
        enfantId: enfant1.id,
        leconId: lecons[0].id,
        complete: true,
        secondesPassees: 900, // 15 minutes
        dernierAcces: new Date(),
      },
    }),
    db.progression.create({
      data: {
        enfantId: enfant1.id,
        leconId: lecons[1].id,
        complete: false,
        secondesPassees: 600, // 10 minutes
        dernierAcces: new Date(),
      },
    }),
  ]);

  console.log("‚úÖ Progressions cr√©√©es");

  // Cr√©er des consentements
  await Promise.all([
    db.consentement.create({
      data: {
        type: "PRIVACY_POLICY",
        userId: parent.id,
      },
    }),
    db.consentement.create({
      data: {
        type: "TERMS_OF_SERVICE",
        userId: parent.id,
      },
    }),
    db.consentement.create({
      data: {
        type: "COOKIES",
        userId: parent.id,
      },
    }),
  ]);

  console.log("‚úÖ Consentements cr√©√©s");

  console.log("üéâ Seeding termin√© avec succ√®s !");
  console.log("\nüìã Comptes de test cr√©√©s :");
  console.log("üë®‚Äçüíº Admin: admin@profsacademie.ca / admin123");
  console.log("üë©‚Äçüè´ Prof: prof@profsacademie.ca / prof123");
  console.log("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent: parent@profsacademie.ca / parent123");
  console.log("üëß Emma (enfant): PIN 1234");
  console.log("üë¶ Lucas (enfant): PIN 5678");
}

main()
  .catch((e) => {
    console.error("‚ùå Erreur lors du seeding:", e);
    process.exit(1);
  })
  .finally(async () => {
    await db.$disconnect();
  });
